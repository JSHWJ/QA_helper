# 자동화 도구 작업 규약 (에이전트 공통)

## 1) 커뮤니케이션/출력

1. 사용자에게 제공하는 설명은 한국어로 작성한다.
2. 코드 식별자(변수/함수/클래스), 코드 구조, 코드 블록은 영어로 작성한다.
3. 변경 후에는 반드시 실행 가능 여부를 확인한다.
4. 문제가 반복되면 추정이 아닌 원인-수정-검증 결과 순서로 보고한다.

## 2) 앱 구조 원칙

1. 현재 앱은 Dash AG Grid 기반 `dash_app.py` 중심으로 유지한다.
2. 비즈니스 로직/유틸/설정은 `app_modules`로 분리한다.
3. 스타일/그리드 규칙은 한 파일에 몰지 않고 모듈(`grid_config`, CSS)로 관리한다.
4. 기능 추가 시 기존 UX를 깨는 대규모 변경을 한 번에 하지 않는다(회귀 방지 우선).

## 3) 비교 데이터 규칙 (반드시 고정)

1. 입력:
   - 딕셔너리 파일(`xlsx`/`csv`)
   - `ko.json`, `ru.json`
   - `en.json`(선택)
2. 정규화:
   - 앞뒤 공백 제거
   - 줄바꿈 통일
   - 연속 공백 축소
   - 전체 따옴표 제거
3. 키/열:
   - `Dictionary English`는 딕셔너리의 English 컬럼 값만 표시
   - JSON-only 키는 `비교 Key`에 표시
   - `데이터출처`는 `양쪽` 또는 `JSON만`
4. 중복:
   - 딕셔너리 English 중복은 병합
   - Korean/Russian은 쉼표 결합
5. 매치 컬럼:
   - `KO_Match`, `EN_Match`, `RU_Match`, `Overall_Match`
   - 상태값: `Y/N/파일없음`
   - JSON 값이 비면 `파일없음`
6. 정렬/순번:
   - `순번`은 고정값
   - 정렬 변경해도 `순번` 값 자체는 변하지 않음
   - 기본은 `순번` 오름차순

## 4) UI/UX 고정 요구사항

1. 한국어 UI 사용.
2. 비교 결과 테이블은 편집 가능, 편집 즉시 매치 재계산.
3. `N` 표시 규칙(핵심):
   - `KO/EN/RU/Overall_Match`에서 값이 `N`이면 노란 배경이 보여야 한다.
   - 이 규칙은 회귀 금지(최우선 고정).
4. 미스매치 편집 보조:
   - 불일치 쌍(사전/JSON) 컬럼 강조(빨간 테두리).
5. 필터:
   - 컬럼 헤더 필터 메뉴에서 값 선택 방식으로 사용.
   - `포함/시작값/끝값` 같은 조건형 텍스트 필터 UX로 회귀 금지.
6. 열 숨기기:
   - 우클릭 숨기기 + 상단 다중 선택 숨기기/해제 지원.
7. 보기 모드:
   - 기본 화면 / 비교결과 전체 화면 전환 유지.

## 5) 저장 경로/보안(퍼블릭 배포 대비)

1. 경로 하드코딩 금지.
2. 저장 경로는 아래 우선순위로 결정:
   1) UI에서 입력/적용된 경로(`store-storage-dir`)
   2) 환경변수 `AUTOMATIC_TOOL_STORAGE_DIR`
   3) 설정 파일 `.automatic_tool_config.json`
   4) 기본 경로(`Desktop/automatic_tool_storage`)
3. 사용자는 앱에서 저장 경로를 직접 변경 가능해야 한다.
4. 민감한 로컬 경로를 코드 상수로 고정하지 않는다.

## 6) 내보내기/기능 범위

1. 구글 스프레드시트 내보내기 기능은 현재 제외.
2. Excel 내보내기:
   - 매치 수식 포함
   - `N` 조건부서식(노란색) 포함
3. CSV 내보내기:
   - 데이터만 저장(서식/수식 없음)
4. 변경점 비교 리포트(기준 CSV/XLSX) 유지.

## 7) AG Grid 트러블슈팅 고정

1. `en.json/ko.json/ru.json`처럼 점(`.`)이 있는 컬럼명은
   `suppressFieldDotNotation: True`를 유지해야 한다.
2. `rowClassRules`는 `dashGridOptions`가 아니라 `AgGrid` 최상위 prop에 둔다.
3. 필터가 조건형으로 보이면 `agSetColumnFilter` 설정을 점검한다.
4. 스타일 미반영 이슈가 있으면:
   - 서버 재시작
   - 브라우저 강력 새로고침(`Ctrl+F5`)
   - 그래도 재현 시 원인 분석 후 렌더 경로 단순화.

## 8) 필수 검증 게이트 (변경마다 수행)

1. 문법 검사:
   - `python3 -m py_compile dash_app.py app_modules/*.py`
2. 데이터 생성 스모크:
   - 레코드 수 > 0
   - 매치 컬럼 분포(`Y/N/파일없음`) 확인
3. 그리드 구성 확인:
   - `result-grid` 컬럼/규칙/필터 설정 확인
4. 회귀 체크:
   - 초기 로드 시 데이터 표시
   - JSON 컬럼 표시
   - `N` 노란색 표시
   - 헤더 값 선택 필터 동작
   - 편집 후 매치 재계산
