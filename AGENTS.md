# 자동화 도구 작업 규약 (에이전트 공통)

## 1) 커뮤니케이션/출력

1. 사용자에게 제공하는 설명은 한국어로 작성한다.
2. 코드 식별자(변수/함수/클래스), 코드 구조, 코드 블록은 영어로 작성한다.
3. 변경 후에는 반드시 실행 가능 여부를 확인한다.
4. 문제가 반복되면 추정이 아닌 원인-수정-검증 결과 순서로 보고한다.

## 2) 앱 구조 원칙

1. 현재 앱은 Streamlit 기반 `app.py` 중심으로 유지한다.
2. 비즈니스 로직/유틸/설정은 `app_modules`로 분리한다.
3. 대용량 처리/비용 높은 연산(예: 내보내기 바이트 생성)은 캐시(`st.cache_data`)를 우선 검토한다.
4. 기능 추가 시 기존 UX를 깨는 대규모 변경을 한 번에 하지 않는다(회귀 방지 우선).

## 3) 비교 데이터 규칙 (고정)

1. 입력 파일:
   - 딕셔너리(`xlsx`/`csv`/`tsv`)
   - `ko.json`, `ru.json`
   - `en.json`(선택)
2. 정규화:
   - 앞뒤 공백 제거
   - 줄바꿈 통일
   - 연속 공백 축소
   - 전체 따옴표 제거
3. 키/열 규칙:
   - `비교 Key`는 비교 기준 키(딕셔너리 + JSON 키 유니온)
   - `Dictionary English`는 딕셔너리 English 원천값
   - JSON-only 키는 `데이터출처=JSON만`, 양쪽에 있으면 `양쪽`
4. 중복 처리:
   - 딕셔너리 English 중복은 병합
   - Korean/Russian은 쉼표 결합
5. 매치 컬럼:
   - `KO_Match`, `EN_Match`, `RU_Match`, `Overall_Match`
   - 상태값: `Y/N/파일없음`
6. 순번/정렬:
   - `순번`은 고정값
   - 기본 정렬 기준은 `순번`
   - UI에서 오름/내림만 전환

## 4) 저장 경로/파일 재사용 규칙

1. 경로 우선순위:
   1) UI에서 `저장 폴더 경로` 입력 후 `폴더 적용`
   2) 환경변수 `AUTOMATIC_TOOL_STORAGE_DIR`
   3) 설정 파일 `.automatic_tool_config.json`
   4) 기본 경로(`Desktop/automatic_tool_storage`)
2. 업로드 파일 저장:
   - `dictionary_latest.*`, `ko_latest.json`, `ru_latest.json`, `en_latest.json`로 저장
   - 재업로드 시 최신 파일 교체
3. 재진입 자동 재사용:
   - 앱 시작 시 저장 폴더의 latest 파일 자동 탐색
   - 딕셔너리 존재 시 자동 비교 1회 실행
4. 업로드 변경 감지:
   - 파일명/크기 + 파일 해시 기반으로 변경 인식

## 5) UI/UX 고정 요구사항

1. 한국어 UI 유지.
2. 테이블은 2개만 유지:
   - 메인 테이블
   - `수정 전 기준 테이블`(expander 내부)
3. 메인 테이블:
   - 조회 모드에서 스타일 강조 적용
   - 편집 모드에서 `st.data_editor`로 수정
   - 페이지네이션 적용(페이지 크기/페이지)
4. 편집 플로우:
   - `시작` -> 값 수정 -> `완료`
   - 완료 시 변경 내역 검토 패널 표시
   - `수락(적용)`/`이전(다시 수정)`/`모두 취소`
5. 강조 규칙:
   - `KO/EN/RU/Overall_Match = N`은 노란 배경
   - 미스매치 쌍(`Dictionary ...` vs `*.json`)은 빨간 테두리
   - 행 선택 시 해당 행의 미스매치 쌍 강조 강화
6. 텍스트 표시:
   - 긴 값은 셀 내부 줄바꿈으로 전체 내용 표시
7. 전체 화면:
   - `비교결과 전체 화면` ON/OFF 상태를 새로고침 후에도 유지

## 6) 필터/검색/보기 규칙

1. 상단 빠른 조건 필터(한 줄):
   - `검색`
   - `KO`, `EN`, `RU`, `ALL` (`전체/Y/N/파일없음`)
   - `정렬`(오름차순/내림차순)
2. 매치 필터 중복 금지:
   - 빠른 조건 필터를 우선 사용
   - 추가 필터(expander)는 매치 컬럼 제외한 일반 컬럼만 대상
3. 열 관리:
   - `숨길 열`, `숨김 해제`, `매치만`
4. 통계:
   - `전체 개수`, `KO/EN/RU 불일치`, `전체 불일치`
   - 현재 필터/검색 결과에 실시간 동기화

## 7) 내보내기/리포트 규칙

1. CSV:
   - 데이터만 저장(서식/수식 없음)
2. Excel:
   - 매치 수식 포함
   - `N` 조건부서식(노란색) 포함
   - `파일없음` 조건부서식(회색) 포함
3. 변경점 비교 리포트:
   - 기준 CSV/XLSX 대비 변경점 테이블 제공

## 8) 필수 검증 게이트 (변경마다 수행)

1. 문법 검사:
   - `python3 -m py_compile app.py app_modules/*.py`
2. 서버 상태:
   - `http://127.0.0.1:8501` 응답 코드 확인
3. 데이터 스모크:
   - 레코드 수 > 0
   - 매치 분포(`Y/N/파일없음`) 확인
4. 회귀 체크:
   - 저장 폴더 재사용/자동 비교
   - 페이지네이션 동작
   - 테이블 2개 구조 유지
   - 편집 검토 플로우 동작
   - 노란색/빨간 강조 규칙 동작
